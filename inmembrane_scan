#!/usr/bin/env python3
"""
Modernized entry point for inmembrane
-------------------------------------

Retains the original basic interface:

    inmembrane_scan [options] sequences.fasta

Key options:

    -c / --config   Path to inmembrane.config (Python-style dict)

The modern workflow runs external predictors:

    - SignalP 6.0
    - TMbed
    - DeepLocPro
    - HMMER (hmmscan)

and then applies the Gram-negative or Gram-positive protocol to
summarize phage receptor candidates.
"""

import sys
from optparse import OptionParser

import inmembrane
from inmembrane.helpers import log_stderr


description = f"""
inmembrane {inmembrane.__version__}

Inmembrane is a proteome annotation pipeline. It takes a FASTA file,
runs predictor modules (SignalP 6.0, TMbed, DeepLocPro, HMMER),
and summarizes the results using Gram-negative or Gram-positive
modern protocols.

(c) 2011–2025 Bosco Ho, Andrew Perry, and contributors
"""


def main():
    usage = "usage: %prog [options] sequences.fasta"
    parser = OptionParser(
        usage=usage,
        version=f"%prog {inmembrane.__version__}",
        description="Modernized inmembrane CLI entry point",
    )

    # === Core options ===
    parser.add_option(
        "-c",
        "--config",
        action="store",
        type="string",
        dest="config_path",
        help=(
            "Path to custom inmembrane.config file "
            "(default: ~/SerraPHIM_v2/tools/inmembrane/inmembrane.config)"
        ),
    )

    (options, args) = parser.parse_args()

    log_stderr(
        f"inmembrane {inmembrane.__version__} "
        "(https://github.com/spyridon-ntokos/inmembrane)"
    )

    # Load parameters (creates a default config if missing)
    params = inmembrane.get_params(options.config_path)

    # Determine FASTA path: CLI arg overrides empty config 'fasta'
    if (not params.get("fasta")) and not args:
        # No FASTA in config and no positional argument → show help & exit
        print(description)
        parser.print_help()
        sys.exit(1)

    if not params.get("fasta") and args:
        params["fasta"] = args[0]

    log_stderr(f"# Using config: {params['_config_path']}")
    log_stderr(f"# Using FASTA: {params['fasta']}")

    inmembrane.process(params)


if __name__ == "__main__":
    main()
